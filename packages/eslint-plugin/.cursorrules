# ESLint Plugin - LLM-Optimized Message Format

You are working in the @forge-js/eslint-plugin package. When creating or modifying ESLint rule messages, **ALWAYS use `formatLLMMessage` utility** from `@forge-js/eslint-plugin-utils`.

## Format Standard

Every error/warning message MUST use `formatLLMMessage` which produces exactly 2 lines:

```
Line 1: [Icon] [CWE?] | [Description] | [SEVERITY]
Line 2:    Fix: [fix instruction] | [documentation link]
```

## Quick Reference

**Severity Levels:** CRITICAL | HIGH | MEDIUM | LOW

**Icons by Category:**

- üîí Security issues (vulnerabilities)
- ‚ö†Ô∏è Warnings/general issues
- üîÑ Refactoring/architecture issues
- ‚ôø Accessibility issues
- ‚ö° Performance issues
- üìö Domain/terminology issues
- üö´ Module/import issues

**CWE References:** https://cwe.mitre.org/

- CWE-89: SQL Injection
- CWE-78: Command Injection
- CWE-95: Code Injection (eval, require)
- CWE-22: Path Traversal
- CWE-400: ReDoS
- CWE-915: Prototype Pollution
- CWE-407: Circular Dependencies
- CWE-431: Insecure Dependency
- CWE-532: Sensitive Data Logging
- CWE-1078: Deprecated API
- CWE-1104: Code Duplication

## Implementation Template

```typescript
import { formatLLMMessage, MessageIcons } from '@forge-js/eslint-plugin-utils';

messages: {
  ruleName: formatLLMMessage({
    icon: MessageIcons.SECURITY, // or appropriate icon
    issueName: 'Issue Name',
    cwe: 'CWE-XXX', // optional, only if relevant
    description: 'Issue description',
    severity: 'CRITICAL', // or HIGH, MEDIUM, LOW
    fix: 'Specific fix instruction with code example',
    documentationLink: 'https://example.com/docs',
  }),
}
```

## DO's ‚úÖ

- **ALWAYS use `formatLLMMessage` utility**
- Import from `@forge-js/eslint-plugin-utils`
- Use `MessageIcons` constants for icons
- Include CWE references when relevant (security, high-impact)
- Provide specific fix instructions with code examples
- Link to documentation
- Use correct severity level (CRITICAL, HIGH, MEDIUM, LOW)
- Test on playground app

## DON'Ts ‚ùå

- Skip CWE references
- Use vague examples
- Provide only problems
- Mix unrelated concepts
- Create biased rules
- Add special-case logic
- Forget severity/icon
- Skip documentation

## ESLint Rule Test Structure

When writing ESLint rule tests using `@typescript-eslint/rule-tester`:

### ‚úÖ CORRECT: error.suggestions structure

```typescript
errors: [
  {
    messageId: 'ruleMessageId',
    suggestions: [
      {
        messageId: 'suggestionMessageId',
        output: 'Expected code after fix'
      }
    ]
  }
]
```

### ‚ùå WRONG: DO NOT use "desc" in suggestions

```typescript
// DO NOT DO THIS - "desc" is NOT supported in error.suggestions
errors: [
  {
    messageId: 'ruleMessageId',
    suggestions: [
      {
        desc: 'Description', // ‚ùå NOT SUPPORTED
        output: 'Expected code after fix'
      }
    ]
  }
]
```

**REASON:** The TypeScript types for `SuggestionOutput<MessageIds>` do not include a `desc` property. ESLint rule tests must use `messageId` to reference suggestion messages defined in the rule's `messages` object.

## Reference Rules

See `/src/rules/` for optimized examples:

- `security/no-sql-injection.ts` - Security example
- `architecture/no-circular-dependencies.ts` - Architecture example
- `development/no-console-log.ts` - Development example

## When in Doubt

1. Check existing rules in the same category
2. Reference the full guide: `.cursor/rules/eslint-rule-llm-format.md`
3. Run `nx lint` on the playground app to verify
4. Ensure message is parseable by both humans and LLMs

## Acceptable Placeholder Usage

Some rules MAY use template placeholders in specific, justified cases:

‚úÖ **ACCEPTABLE Examples:**

- Domain-specific terms (`{{correctTerm}}`) - varies per project glossary
- Accessibility levels (`{{wcagLevel}}`) - varies per context (A, AA, AAA)
- Contextual locations (`{{location}}`) - varies by error source (onClick, map, etc.)

‚ùå **NOT ACCEPTABLE Examples:**

- Main message severity (`{{severity}}`) - should be static (CRITICAL/HIGH/MEDIUM/LOW)
- CWE references (`{{cweCode}}`) - should be static (CWE-89, CWE-95, etc.)
- Core examples (`{{currentExample}}`, `{{fixExample}}`) - should have static, concrete examples

**Rules that use acceptable placeholders:**

- `img-requires-alt` - Uses dynamic WCAG level and affected user count (justified)
- `react-no-inline-functions` - Uses dynamic location context (justified)
- `enforce-naming` - Uses dynamic domain terms (justified)

**Recent Audit Results (Nov 2, 2025):**

- 5/19 rules: Perfect static format ‚úÖ
- 3/19 rules: Acceptable with justified placeholders üü°
- 3/19 rules: FIXED critical template placeholder issues üî¥
- 8/19 rules: Full review needed ‚ö†Ô∏è
- See: `AUDIT_REPORT_LLM_OPTIMIZATION.md` for complete findings

---

## üìã New Lint Rule Implementation Checklist

When implementing a new ESLint rule, follow this comprehensive checklist below.

### Phase 1: Rule Implementation

- [ ] **Create rule file** (`packages/eslint-plugin/src/rules/{category}/{rule-name}.ts`)
  - [ ] Implement rule logic with AST traversal
  - [ ] Add proper TypeScript types
  - [ ] Use `createRule` utility from `../../utils/create-rule`
  - [ ] Use `formatLLMMessage` for error messages (see format standard above)
  - [ ] Include CWE reference in error message
  - [ ] Add auto-fix suggestions where appropriate

- [ ] **Create test file** (`packages/eslint-plugin/src/tests/{rule-name}.test.ts`)
  - [ ] Add valid test cases (should not trigger rule)
  - [ ] Add invalid test cases (should trigger rule)
  - [ ] Test edge cases and false positives
  - [ ] Test auto-fix suggestions (if applicable)
  - [ ] Aim for 100% code coverage
  - [ ] Use `RuleTester` from `@typescript-eslint/rule-tester`

- [ ] **Register rule** (`packages/eslint-plugin/src/index.ts`)
  - [ ] Add to flat rule names (e.g., `'no-rule-name': ruleFunction`)
  - [ ] Add to categorized rule names (e.g., `'security/no-rule-name': ruleFunction`)
  - [ ] Export rule function

- [ ] **Update configs** (`packages/eslint-plugin/src/index.ts`)
  - [ ] Add to `recommended` config (if appropriate)
  - [ ] Add to `strict` config (if appropriate)
  - [ ] Add to category-specific configs (e.g., `security` config)
  - [ ] Set appropriate severity level (`error` or `warn`)

### Phase 2: Documentation

- [ ] **Create rule documentation** (`packages/eslint-plugin/docs/rules/{rule-name}.md`)
  - [ ] Follow AEO (AI Engine Optimization) guidelines
  - [ ] Use mermaid diagrams for visual flows
  - [ ] Use tables instead of long paragraphs
  - [ ] Include rule metadata table
  - [ ] Include examples (valid/invalid code)
  - [ ] Include configuration options
  - [ ] Include CWE reference and security context
  - [ ] Include auto-fix information
  - [ ] Include related rules

- [ ] **Update main README** (`packages/eslint-plugin/README.md`)
  - [ ] Add rule to appropriate category table
  - [ ] Add rule link to documentation
  - [ ] Update rule count (currently 30+ rules, 18 security rules)
  - [ ] Mark appropriate icons (üíº ‚ö†Ô∏è üîß üí°)

- [ ] **Update all package READMEs**
  - [ ] `packages/eslint-plugin-llm/README.md`
  - [ ] `packages/eslint-plugin-mcp/README.md`
  - [ ] `packages/eslint-plugin-mcp-optimized/README.md`
  - [ ] `packages/eslint-plugin-llm-optimized/README.md` (if different from main)
  - [ ] Update rule counts and feature lists

- [ ] **Update AGENTS.md** (`packages/eslint-plugin/AGENTS.md`)
  - [ ] Add rule to rule categories table
  - [ ] Include rule name, description, CWE, auto-fixable status
  - [ ] Update rule counts

### Phase 3: Release Preparation

- [ ] **Update CHANGELOG.md** (`packages/eslint-plugin/CHANGELOG.md`)
  - [ ] Add entry for new rule(s)
  - [ ] Include rule name, description, CWE reference
  - [ ] Mark as feature addition

- [ ] **Update ROADMAP.md** (`ROADMAP.md` in repository root)
  - [ ] Mark rule as completed: `- [x]` instead of `- [ ]`
  - [ ] Update status if applicable

- [ ] **Verify tests pass**
  - [ ] Run `pnpm nx run eslint-plugin:test`
  - [ ] Ensure 100% test coverage for new rule
  - [ ] Fix any failing tests

- [ ] **Verify build succeeds**
  - [ ] Run `pnpm nx run eslint-plugin:build`
  - [ ] Check dist folder contains rule files

- [ ] **Verify documentation is included**
  - [ ] Check `package.json` `files` array includes `docs/`
  - [ ] Check `project.json` `assets` includes `docs/rules/*.md`
  - [ ] Verify README.md, LICENSE, CHANGELOG.md, AGENTS.md are included

### AEO-Optimized Documentation Template

When creating rule documentation, follow this structure:

```markdown
# Rule Name

## Metadata

| Property | Value |
|----------|-------|
| **CWE** | CWE-XXX |
| **Severity** | HIGH/MEDIUM/LOW |
| **Auto-fixable** | Yes/No |
| **Category** | Security/Development/Architecture/etc. |

## Overview

[Brief description with mermaid diagram showing detection flow]

## Examples

### ‚ùå Invalid

[Code examples that trigger the rule]

### ‚úÖ Valid

[Code examples that don't trigger the rule]

## Configuration

[Configuration options table]

## Related Rules

[Links to related rules]
```

### Quality Standards

- **Test Coverage**: Aim for 100% code coverage
- **Documentation**: AEO-optimized with tables, mermaid diagrams, minimal prose
- **Error Messages**: Use `formatLLMMessage` with structured context (see format standard above)
- **Auto-fixes**: Provide suggestions where safe and deterministic
- **CWE References**: Include CWE number and link in error messages
- **Type Safety**: Full TypeScript support with proper types

### Current Status

- **Total Rules**: 30+ rules
- **Security Rules**: 18 rules
- **Recently Added**:
  - ‚úÖ `no-insecure-cookie-settings` (CWE-614)
  - ‚úÖ `no-missing-csrf-protection` (CWE-352)
  - ‚úÖ `no-exposed-sensitive-data` (CWE-200)
  - ‚úÖ `no-unencrypted-transmission` (CWE-319)

### Related Documents

- [RELEASE_GUIDE.md](../../RELEASE_GUIDE.md) - Release preparation checklist
- [ROADMAP.md](../../ROADMAP.md) - Planned rules and features
- [CONTRIBUTING.md](../../CONTRIBUTING.md) - Contribution guidelines
