# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  workflow_dispatch:
    inputs:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION STRATEGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      version-specifier:
        description: "Version bump strategy (auto = conventional commits)"
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
          - premajor
          - preminor
          - prepatch
          - prerelease
        default: "auto"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NPM PUBLISHING OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      dist-tag:
        description: "NPM distribution tag"
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
          - rc
          - alpha
          - canary
        default: "latest"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CONTROL FLOW OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      run-ci:
        description: "Run CI validation before publishing"
        required: false
        type: boolean
        default: true

      dry-run:
        description: "Dry run: preview changes without modifying git or NPM"
        required: false
        type: boolean
        default: false

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL ENVIRONMENT VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.18.3"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: CI VALIDATION (Optional, skippable)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-ci:
    name: âœ… CI Validation
    runs-on: ubuntu-latest
    if: inputs.run-ci == true
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: none

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true # Fetch tags for completeness (though not strictly needed for CI validation)

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      - name: ðŸ§ª Test all packages
        run: pnpm nx run-many -t test --all -c ci --parallel=4 --verbose

      - name: ðŸ—ï¸ Build all packages
        run: pnpm nx run-many -t build --all --parallel=4 --verbose

      - name: âœ… CI validation passed
        run: |
          echo "## âœ… CI Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests and builds completed successfully." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: RELEASE (Version bump, build, changelog, tags, publish)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸš€ Release & Publish
    runs-on: ubuntu-latest
    # Only require CI if it was enabled and run
    if: always() && (inputs.run-ci == false || needs.validate-ci.result == 'success' || needs.validate-ci.result == 'skipped')
    needs: [validate-ci]
    timeout-minutes: 15
    permissions:
      contents: write # Required to push commits/tags and create PRs
      id-token: write # â† Required for Trusted Publishing (OIDC)
      pull-requests: write # Required to create PR if direct push fails

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: main # Always checkout main branch for releases (ensures all tags are reachable)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Verify we're on main branch
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "âŒ Error: Release workflow must run on main branch"
            echo "   Current branch: $CURRENT_BRANCH"
            echo "   Expected: main"
            exit 1
          fi
          echo "âœ… Confirmed: Running on main branch (all tags are reachable)"

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/
          cache: "pnpm"

      - name: ðŸ“‚ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PRE-FLIGHT CHECKS (Before making any changes)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Pre-Flight Checks
        if: inputs.dry-run == false
        run: |
          echo "ðŸ” Running pre-flight checks..."

          # Check NPM authentication (Trusted Publishing / OIDC)
          # Note: setup-node@v6 with registry-url automatically configures OIDC authentication
          # NODE_AUTH_TOKEN is set by GitHub Actions when using OIDC
          echo "ðŸ“¦ Checking NPM authentication setup (Trusted Publishing)..."

          # Verify OIDC token is present (set by GitHub Actions when using OIDC)
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN not found!"
            echo "   This workflow uses Trusted Publishing (OIDC) for NPM authentication"
            echo "   Ensure:"
            echo "   1. Trusted Publishing is configured on npmjs.com for this repository"
            echo "   2. GitHub Actions has 'id-token: write' permission (already set)"
            echo "   3. setup-node action is configured with registry-url (already set)"
            exit 1
          fi

          echo "âœ… OIDC token detected (NODE_AUTH_TOKEN is set)"

          # Verify npm registry is configured correctly
          echo "ðŸ” Verifying npm registry configuration..."
          NPM_REGISTRY=$(npm config get registry 2>/dev/null || echo "")
          if [ "$NPM_REGISTRY" != "https://registry.npmjs.org/" ]; then
            echo "âš ï¸  Warning: npm registry is not set to https://registry.npmjs.org/"
            echo "   Current registry: ${NPM_REGISTRY:-not set}"
            echo "   This may cause authentication issues"
          else
            echo "âœ… npm registry configured correctly: $NPM_REGISTRY"
          fi

          # Try to verify authentication by checking if we can access one of our packages
          # This is a read-only operation that works with OIDC tokens
          echo "ðŸ” Verifying package access (read-only check)..."
          TEST_PACKAGE="@forge-js/eslint-plugin-utils"
          if npm view "$TEST_PACKAGE" version --registry=https://registry.npmjs.org/ >/dev/null 2>&1; then
            PACKAGE_VERSION=$(npm view "$TEST_PACKAGE" version --registry=https://registry.npmjs.org/ 2>/dev/null || echo "unknown")
            echo "âœ… Successfully accessed package: $TEST_PACKAGE@$PACKAGE_VERSION"
            echo "   This confirms npm registry connectivity"
            echo "   Note: OIDC authentication will be fully validated during publish"
          else
            echo "âš ï¸  Warning: Could not access package $TEST_PACKAGE"
            echo "   This may be normal if:"
            echo "   - Package doesn't exist yet (first publish)"
            echo "   - Network issues"
            echo "   - Trusted Publishing not fully configured"
            echo "   Authentication will still be validated during actual publish"
          fi

          echo "âœ… Pre-flight authentication checks completed"
          echo "   Final authentication will be validated during publish step"

          # Check git state is clean
          echo "ðŸ“ Checking git state..."
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸  Warning: Working directory has uncommitted changes"
            echo "   This may cause issues during release"
            git status --short
          else
            echo "âœ… Git working directory is clean"
          fi

          # Check git tags alignment with package.json versions
          echo "ðŸ” Verifying git tags alignment with package.json versions..."
          TAG_MISMATCH=false
          for pkg in eslint-plugin eslint-plugin-llm-optimized eslint-plugin-utils cli eslint-plugin-llm eslint-plugin-mcp eslint-plugin-mcp-optimized; do
            if [ -f "packages/$pkg/package.json" ]; then
              PKG_VERSION=$(cat packages/$pkg/package.json | grep '"version"' | cut -d'"' -f4)
              LATEST_TAG=$(git tag | grep "^${pkg}@" | sort -V | tail -1 || echo "")
              if [ -n "$LATEST_TAG" ]; then
                TAG_VERSION=$(echo "$LATEST_TAG" | cut -d'@' -f2)
                if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
                  echo "âš ï¸  Warning: $pkg version mismatch - package.json=$PKG_VERSION, tag=$TAG_VERSION"
                  TAG_MISMATCH=true
                fi
              else
                echo "â„¹ï¸  No existing tag for $pkg (first release or tag format changed)"
              fi
            fi
          done
          if [ "$TAG_MISMATCH" = "true" ]; then
            echo "âš ï¸  Version mismatches detected - nx release version will align them"
            echo "   This is expected if versions were manually updated"
          else
            echo "âœ… All package versions align with git tags"
          fi

          # Check for potential tag conflicts (tags that would be created)
          echo "ðŸ” Checking for potential tag conflicts..."
          DRY_RUN_OUTPUT=$(pnpm nx release version --dry-run 2>&1 || true)
          if echo "$DRY_RUN_OUTPUT" | grep -q "No changes detected"; then
            echo "â„¹ï¸  No changes detected for release"
            echo "   This means there are no conventional commits since the last release"
            echo "   The release will skip version bumping"
          else
            echo "âœ… Changes detected - release will proceed"
            # Extract potential new versions from dry-run output
            POTENTIAL_TAGS=$(echo "$DRY_RUN_OUTPUT" | grep -oE '[a-z-]+@[0-9]+\.[0-9]+\.[0-9]+' || echo "")
            if [ -n "$POTENTIAL_TAGS" ]; then
              echo "ðŸ“ Potential new tags to be created:"
              echo "$POTENTIAL_TAGS" | while read tag; do
                if git rev-parse "$tag" >/dev/null 2>&1; then
                  echo "âš ï¸  Warning: Tag $tag already exists - this may cause issues"
                else
                  echo "   âœ… $tag (will be created)"
                fi
              done
            fi
          fi

          # Verify we have all necessary tags reachable from main
          echo "ðŸ” Verifying tag reachability from main branch..."
          MISSING_TAGS=false
          for pkg in eslint-plugin eslint-plugin-llm-optimized eslint-plugin-utils cli eslint-plugin-llm eslint-plugin-mcp eslint-plugin-mcp-optimized; do
            if [ -f "packages/$pkg/package.json" ]; then
              PKG_VERSION=$(cat packages/$pkg/package.json | grep '"version"' | cut -d'"' -f4)
              EXPECTED_TAG="${pkg}@${PKG_VERSION}"
              if git rev-parse "$EXPECTED_TAG" >/dev/null 2>&1; then
                # Check if tag is reachable from current HEAD
                if ! git merge-base --is-ancestor "$EXPECTED_TAG" HEAD 2>/dev/null; then
                  echo "âš ï¸  Warning: Tag $EXPECTED_TAG exists but is not reachable from main"
                  echo "   This may cause version resolution issues"
                  MISSING_TAGS=true
                fi
              fi
            fi
          done
          if [ "$MISSING_TAGS" = "true" ]; then
            echo "âš ï¸  Some tags are not reachable - this may affect version resolution"
            echo "   Nx will use fallback version resolution (disk-based) if needed"
          else
            echo "âœ… All existing tags are reachable from main branch"
          fi

          echo "âœ… All pre-flight checks passed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 1: PREPARE VERSION (Build + determine versions + update changelogs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ Prepare Release Version
        id: prepare
        if: inputs.dry-run == false
        run: |
          # Configure git user for automated commits
          git config user.name "Ofri Peretz"
          git config user.email "ofri@snappy.com"

          # Run version command (includes preVersionCommand build for manifest updates)
          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Using version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }}
          else
            echo "ðŸ“ Using conventional commits to determine version"
            pnpm nx release version
          fi

          echo "status=success" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 2: CREATE RELEASE PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # After nx release version, we create a PR with the version changes
      # This is BEST PRACTICE: safer, more transparent, works with any protection
      - name: ðŸ“ Create Release PR
        if: inputs.dry-run == false
        run: |
          echo "ðŸ“ Creating release PR (best practice approach)..."
          echo ""
          echo "âœ… Benefits of PR-based releases:"
          echo "   - You can review what's being released"
          echo "   - Works with any branch protection setup"
          echo "   - No special configuration needed"
          echo "   - Industry standard approach"
          echo ""

          # Check if there are commits to push (nx release version creates commits)
          if git diff --quiet HEAD origin/main; then
            echo "â„¹ï¸  No local changes (versions already match remote)"
            echo "   Skipping PR creation - versions are already on main"
            echo "skip_pr=true" >> $GITHUB_ENV
          else
            # Get the commits that were created by nx release version
            COMMITS_TO_PUSH=$(git log origin/main..HEAD --oneline | wc -l)
            TAGS_TO_PUSH=$(git tag --list --no-merged origin/main | wc -l)
            
            echo "ðŸ“ Found $COMMITS_TO_PUSH commit(s) and $TAGS_TO_PUSH tag(s) to release"
            echo ""
            
            # Fetch latest from origin
            git fetch origin main
            
            # Check if main has moved ahead
            if ! git merge-base --is-ancestor origin/main HEAD; then
              echo "âš ï¸  Main branch has moved ahead - rebasing..."
              git rebase origin/main || {
                echo "âŒ Rebase failed - conflicts detected"
                echo "   Please resolve conflicts manually and re-run"
                exit 1
              }
            fi
            
            # Create release branch
            RELEASE_BRANCH="chore/release-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$RELEASE_BRANCH"
            
            # Push branch
            echo "ðŸ“¤ Pushing release branch: $RELEASE_BRANCH"
            git push origin "$RELEASE_BRANCH" || {
              echo "âŒ Failed to push release branch"
              exit 1
            }
            
            # Create PR
            PR_TITLE="chore(release): Update package versions"
            # Build PR body - using printf to avoid YAML linter issues
            PR_BODY=$(printf "ðŸ¤– **Automated Release PR**\n\nThis PR contains version updates from the release workflow.\n\n**Commits:** %s\n**Tags:** %s\n\n**âš ï¸ IMPORTANT:** Merge this PR to complete the release.\nAfter merging, re-run the release workflow to publish packages to npm." "$COMMITS_TO_PUSH" "$TAGS_TO_PUSH")
            
            if command -v gh &> /dev/null; then
              PR_URL=$(gh pr create \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                --base main \
                --head "$RELEASE_BRANCH" \
                --label "release" \
                --json url --jq '.url' 2>&1) || {
                PR_URL="https://github.com/${{ github.repository }}/compare/main...$RELEASE_BRANCH?expand=1"
              }
            else
              PR_URL="https://github.com/${{ github.repository }}/compare/main...$RELEASE_BRANCH?expand=1"
            fi
            
            echo ""
            echo "âœ… Created release PR: $PR_URL"
            echo ""
            echo "ðŸ“‹ Next steps:"
            echo "   1. Review and merge the PR"
            echo "   2. Re-run this workflow to publish packages"
            echo ""
            echo "pr_created=true" >> $GITHUB_ENV
            echo "pr_url=$PR_URL" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 3: PUBLISH (preReleaseCommand rebuilds with new versions + publish)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Note: Publishing happens after the release PR is merged
      # If PR was just created, skip publishing (user needs to merge PR first)
      - name: ðŸš€ Publish Packages
        id: publish
        if: inputs.dry-run == false && env.pr_created != 'true'
        run: |
          # Configure git user for automated commits
          git config user.name "Ofri Peretz"
          git config user.email "ofri@snappy.com"

          echo "ðŸ“ Publishing with dist tag: ${{ inputs.dist-tag }}"
          echo ""

          # Pre-check: Verify versions to be published don't already exist on npm
          echo "ðŸ” Pre-checking npm registry for version conflicts..."
          PUBLISH_FAILED=false
          for pkg in "@forge-js/eslint-plugin" "@forge-js/eslint-plugin-llm-optimized" "@forge-js/eslint-plugin-utils" "@forge-js/cli" "eslint-plugin-llm" "eslint-plugin-mcp" "eslint-plugin-mcp-optimized"; do
            # Get package name from path
            if [[ "$pkg" == @* ]]; then
              PKG_NAME="$pkg"
            else
              PKG_NAME="$pkg"
            fi
            
            # Get version from dist package.json
            PKG_DIR=$(echo "$pkg" | sed 's/@forge-js\///' | sed 's/eslint-plugin/eslint-plugin/')
            if [ -f "dist/packages/$PKG_DIR/package.json" ]; then
              VERSION=$(cat dist/packages/$PKG_DIR/package.json | grep '"version"' | cut -d'"' -f4)
              if npm view "$PKG_NAME@$VERSION" version >/dev/null 2>&1; then
                echo "âš ï¸  Warning: $PKG_NAME@$VERSION already exists on npm"
                echo "   This package will be skipped during publish"
                PUBLISH_FAILED=true
              else
                echo "âœ… $PKG_NAME@$VERSION is ready to publish"
              fi
            fi
          done
          if [ "$PUBLISH_FAILED" = "true" ]; then
            echo ""
            echo "âš ï¸  Some versions already exist on npm"
            echo "   Nx will skip publishing these packages automatically"
            echo "   This is expected if you're re-running a release"
          fi
          echo ""

          # Note: Trusted Publishing (OIDC) works for scoped packages (@forge-js/*)
          # For unscoped packages (eslint-plugin-llm-optimized, eslint-plugin-mcp, etc.),
          # Trusted Publishing requires npm support approval OR use NPM_TOKEN fallback
          # 
          # If you see 404 errors for unscoped packages, you need to either:
          # 1. Contact npm support to enable Trusted Publishing for unscoped packages
          # 2. Use NPM_TOKEN secret for unscoped packages (fallback)
          # 3. Move packages to @forge-js scope
          #
          # The actual publish command will validate authentication
          # If auth fails, publish will fail with a clear error message

          # preReleaseCommand rebuilds packages with updated versions, then publishes
          # This will validate NPM authentication during the publish operation
          pnpm nx release publish --tag ${{ inputs.dist-tag }}
        env:
          NPM_CONFIG_PROVENANCE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Uncomment below if you need NPM_TOKEN for unscoped packages:
          # NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DRY RUN: Just preview changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Dry Run Preview
        if: inputs.dry-run == true
        run: |
          echo "ðŸ” DRY RUN MODE: Previewing changes only"

          # Construct the dry-run flag
          DRY_RUN_FLAG="--dry-run"

          # Preview version changes
          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Previewing version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }} $DRY_RUN_FLAG
          else
            echo "ðŸ“ Previewing conventional commits version"
            pnpm nx release version $DRY_RUN_FLAG
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY REPORTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generate Release Summary
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "## ðŸ” Dry Run Preview Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** ${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… This was a dry-run preview - no changes committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** \`${{ inputs.dist-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-utils\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/cli\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To install the new version:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pnpm add @forge-js/eslint-plugin@${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
