# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release Scoped Packages

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW PURPOSE: Publish SCOPED packages (@forge-js/*) only
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Packages handled by this workflow:
#   - @forge-js/eslint-plugin-llm-optimized (project: eslint-plugin)
#   - @forge-js/eslint-plugin-utils (project: eslint-plugin-utils)
#   - @forge-js/cli (project: cli)
#
# Authentication: Trusted Publishing (OIDC) via NODE_AUTH_TOKEN
# Scope: @forge-js (configured in setup-node@v6)
#
# For UNscoped packages, use: release-unscoped.yml
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION STRATEGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      version-specifier:
        description: "Version bump strategy (auto = conventional commits)"
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
          - premajor
          - preminor
          - prepatch
          - prerelease
        default: "auto"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NPM PUBLISHING OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      dist-tag:
        description: "NPM distribution tag"
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
          - rc
          - alpha
          - canary
        default: "latest"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CONTROL FLOW OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      run-ci:
        description: "Run CI validation before publishing (slows down release)"
        required: false
        type: boolean
        default: true

      dry-run:
        description: "Dry run: preview changes without modifying git or NPM"
        required: false
        type: boolean
        default: false

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL ENVIRONMENT VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.18.3"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: CI VALIDATION (Optional, skippable)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-ci:
    name: âœ… CI Validation
    runs-on: ubuntu-latest
    if: inputs.run-ci == true
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: none

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true # Fetch tags for completeness (though not strictly needed for CI validation)

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      - name: ðŸ§ª Test all packages
        run: |
          pnpm nx run-many -t test --all -c ci --parallel=4 --verbose
        env:
          # Nx Cloud disabled - using local cache only
          NX_SKIP_NX_CLOUD: "true"

      - name: ðŸ—ï¸ Build all packages
        run: |
          pnpm nx run-many -t build --all --parallel=4 --verbose
        env:
          # Nx Cloud disabled - using local cache only
          NX_SKIP_NX_CLOUD: "true"

      - name: âœ… CI validation passed
        run: |
          echo "## âœ… CI Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests and builds completed successfully." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: RELEASE (Version bump, build, changelog, tags, publish)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸš€ Release & Publish
    runs-on: ubuntu-latest
    environment: production
    # Only require CI if it was enabled and run
    if: always() && (inputs.run-ci == false || needs.validate-ci.result == 'success' || needs.validate-ci.result == 'skipped')
    needs: [validate-ci]
    timeout-minutes: 15
    permissions:
      contents: write # Required to push commits/tags and create PRs
      id-token: write # â† Required for Trusted Publishing (OIDC)
      pull-requests: write # Required to create PR if direct push fails

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: main # Always checkout main branch for releases (ensures all tags are reachable)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js (Trusted Publishing for Scoped Packages)
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/
          cache: "pnpm"
          scope: "@forge-js"
          # Trusted Publishing (OIDC) is automatically configured for @forge-js scope
          # via NODE_AUTH_TOKEN environment variable
          # This ensures scoped packages use Trusted Publishing, not NPM_TOKEN

      - name: ðŸ“‚ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # VERIFY TRUSTED PUBLISHING (SCOPED PACKAGES ONLY)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Verify Trusted Publishing
        if: inputs.dry-run == false
        run: |
          echo "ðŸ” Verifying Trusted Publishing for scoped packages..."
          echo ""
          echo "ðŸ“¦ This workflow publishes SCOPED packages only:"
          echo "   - @forge-js/eslint-plugin-llm-optimized"
          echo "   - @forge-js/eslint-plugin-utils"
          echo "   - @forge-js/cli"
          echo ""
          echo "ðŸ“¦ For UNscoped packages, use: release-unscoped.yml workflow"
          echo ""

          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN not found - Trusted Publishing not configured"
            echo "   Check: https://www.npmjs.com/org/forge-js/settings/publishing"
            exit 1
          fi

          echo "âœ… Trusted Publishing configured (NODE_AUTH_TOKEN found)"
          echo "   Scope: @forge-js (set in setup-node@v6)"
          echo "   Authentication: OIDC via Trusted Publishing"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # QUICK PRE-FLIGHT CHECK (SCOPED PACKAGES ONLY)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Quick Pre-Flight Check
        if: inputs.dry-run == false
        run: |
          # Verify Trusted Publishing (OIDC) for scoped packages
          echo "ðŸ” Checking Trusted Publishing authentication..."

          if [ -n "$NODE_AUTH_TOKEN" ]; then
            echo "âœ… NODE_AUTH_TOKEN found (Trusted Publishing available)"
            echo "   Scope: @forge-js (configured in setup-node@v6)"
          else
            echo "âŒ NODE_AUTH_TOKEN not found - Trusted Publishing not configured"
            echo "   Check: https://www.npmjs.com/org/forge-js/settings/publishing"
            exit 1
          fi

          echo "âœ… Authentication ready for scoped packages"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 1: PREPARE VERSION (Build + determine versions + update changelogs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ Prepare Release Version
        id: prepare
        if: inputs.dry-run == false
        run: |
          # Configure git user for automated commits
          git config user.name "Ofri Peretz"
          git config user.email "ofriperetzdev@gmail.com"

          # Explicit list of scoped packages
          # Projects: eslint-plugin â†’ @forge-js/eslint-plugin-llm-optimized
          #           eslint-plugin-utils â†’ @forge-js/eslint-plugin-utils
          #           cli â†’ @forge-js/cli
          SCOPED_PROJECTS="eslint-plugin,eslint-plugin-utils,cli"

          # Get affected projects and filter to only scoped packages
          echo "ðŸ” Detecting affected scoped packages..."
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --base=HEAD~1 2>/dev/null | grep -E "^($(echo $SCOPED_PROJECTS | tr ',' '|'))$" | tr '\n' ',' | sed 's/,$//' || echo "")

          if [ -z "$AFFECTED_PROJECTS" ]; then
            echo "â„¹ï¸  No affected scoped packages detected"
            echo "   Checking all scoped packages for changes..."
            # Fallback: check if any scoped project has changes
            for PROJECT in $(echo $SCOPED_PROJECTS | tr ',' ' '); do
              if git diff --quiet HEAD~1 HEAD -- "packages/$PROJECT" 2>/dev/null; then
                echo "   - $PROJECT: no changes"
              else
                echo "   - $PROJECT: has changes"
                if [ -z "$AFFECTED_PROJECTS" ]; then
                  AFFECTED_PROJECTS="$PROJECT"
                else
                  AFFECTED_PROJECTS="$AFFECTED_PROJECTS,$PROJECT"
                fi
              fi
            done
          fi

          if [ -z "$AFFECTED_PROJECTS" ]; then
            echo "âœ… No scoped packages have changes - nothing to release"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ“¦ Affected SCOPED packages: $AFFECTED_PROJECTS"
          echo "   (filtered from explicit list: $SCOPED_PROJECTS)"
          echo ""

          # Try to run version command
          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Using version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }} --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
          else
            echo "ðŸ“ Using conventional commits to determine version"
            pnpm nx release version --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
          fi
          EXIT_CODE=${PIPESTATUS[0]}
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "âš ï¸  Version command failed with exit code: $EXIT_CODE"
            
            # Check if the error is about existing tags
            if grep -q "tag.*already exists" /tmp/nx-release-output.log; then
              echo "ðŸ§¹ Detected existing tags from previous failed release attempt"
              echo "   Checking if corresponding npm versions exist..."
              
              # Extract tag names from error message
              CONFLICTING_TAGS=$(grep -oE '[a-z-]+@[0-9]+\.[0-9]+\.[0-9]+' /tmp/nx-release-output.log | sort -u || echo "")
              
              if [ -n "$CONFLICTING_TAGS" ]; then
                for TAG in $CONFLICTING_TAGS; do
                  # Extract project name and version from tag (format: project@version)
                  PROJECT=$(echo "$TAG" | cut -d'@' -f1)
                  VERSION=$(echo "$TAG" | cut -d'@' -f2)
                  
                  echo "   ðŸ” Checking tag: $TAG"
                  
                  # Get package name from project.json or package.json
                  PACKAGE_NAME=""
                  if [ -f "packages/${PROJECT}/package.json" ]; then
                    PACKAGE_NAME=$(node -p "require('./packages/${PROJECT}/package.json').name" 2>/dev/null || echo "")
                  fi
                  
                  if [ -z "$PACKAGE_NAME" ]; then
                    # Try to map project name to package name
                    case "$PROJECT" in
                      "eslint-plugin")
                        PACKAGE_NAME="@forge-js/eslint-plugin-llm-optimized"
                        ;;
                      "eslint-plugin-utils")
                        PACKAGE_NAME="@forge-js/eslint-plugin-utils"
                        ;;
                      "cli")
                        PACKAGE_NAME="@forge-js/cli"
                        ;;
                      *)
                        PACKAGE_NAME="$PROJECT"
                        ;;
                    esac
                  fi
                  
                  # Check if version exists on npm
                  echo "      Checking npm for: $PACKAGE_NAME@$VERSION"
                  if npm view "${PACKAGE_NAME}@${VERSION}" version >/dev/null 2>&1; then
                    echo "      âœ… Version $VERSION exists on npm - skipping tag deletion"
                    echo "      â„¹ï¸  Package already published, will skip in publish step"
                  else
                    echo "      âŒ Version $VERSION does NOT exist on npm"
                    echo "      ðŸ—‘ï¸  Deleting tag $TAG (tag exists but npm version doesn't)"
                    git tag -d "$TAG" 2>/dev/null || true
                    git push origin ":refs/tags/$TAG" 2>/dev/null || true
                    echo "      âœ… Tag deleted - will be recreated by nx release version"
                  fi
                done
                
                echo "   âœ… Cleaned up tags where npm versions don't exist"
                echo "   ðŸ”„ Retrying version command (will recreate deleted tags)..."
                
                # Retry the version command
                if [ "${{ inputs.version-specifier }}" != "auto" ]; then
                  pnpm nx release version ${{ inputs.version-specifier }} --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
                else
                  pnpm nx release version --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
                fi
                RETRY_EXIT_CODE=${PIPESTATUS[0]}
                if [ "$RETRY_EXIT_CODE" -ne 0 ]; then
                  echo "   âŒ Retry failed with exit code: $RETRY_EXIT_CODE"
                  cat /tmp/nx-release-output.log
                  exit $RETRY_EXIT_CODE
                fi
                
                # Verify tags were recreated
                echo "   ðŸ” Verifying tags were recreated..."
                for TAG in $CONFLICTING_TAGS; do
                  PROJECT=$(echo "$TAG" | cut -d'@' -f1)
                  VERSION=$(echo "$TAG" | cut -d'@' -f2)
                  
                  if [ -f "packages/${PROJECT}/package.json" ]; then
                    PACKAGE_NAME=$(node -p "require('./packages/${PROJECT}/package.json').name" 2>/dev/null || echo "")
                    if [ -z "$PACKAGE_NAME" ]; then
                      case "$PROJECT" in
                        "eslint-plugin")
                          PACKAGE_NAME="@forge-js/eslint-plugin-llm-optimized"
                          ;;
                        "eslint-plugin-utils")
                          PACKAGE_NAME="@forge-js/eslint-plugin-utils"
                          ;;
                        "cli")
                          PACKAGE_NAME="@forge-js/cli"
                          ;;
                        *)
                          PACKAGE_NAME="$PROJECT"
                          ;;
                      esac
                    fi
                    
                    # Only check if npm version doesn't exist (we deleted the tag for these)
                    if ! npm view "${PACKAGE_NAME}@${VERSION}" version >/dev/null 2>&1; then
                      if git rev-parse "$TAG" >/dev/null 2>&1; then
                        echo "      âœ… Tag $TAG was successfully recreated"
                      else
                        echo "      âš ï¸  Warning: Tag $TAG was not recreated, creating manually..."
                        # Get the current commit (where package.json was updated)
                        COMMIT_SHA=$(git rev-parse HEAD)
                        git tag "$TAG" "$COMMIT_SHA"
                        echo "      âœ… Manually created tag $TAG"
                      fi
                    fi
                  fi
                done
              else
                # Fallback: try to extract from updated package.json files
                echo "   ðŸ” Attempting to extract from package.json files..."
                UPDATED_FILES=$(git diff --name-only HEAD packages/*/package.json dist/packages/*/package.json 2>/dev/null || echo "")
                
                if [ -n "$UPDATED_FILES" ]; then
                  for FILE in $UPDATED_FILES; do
                    if [ -f "$FILE" ]; then
                      PACKAGE_NAME=$(node -p "require('./$FILE').name" 2>/dev/null || echo "")
                      NEW_VERSION=$(node -p "require('./$FILE').version" 2>/dev/null || echo "")
                      
                      if [ -n "$PACKAGE_NAME" ] && [ -n "$NEW_VERSION" ]; then
                        # Map to project name
                        PROJECT=$(echo "$FILE" | sed -n 's|.*packages/\([^/]*\)/.*|\1|p')
                        if [ -n "$PROJECT" ]; then
                          TAG="${PROJECT}@${NEW_VERSION}"
                          if git rev-parse "$TAG" >/dev/null 2>&1; then
                            # Check npm
                            if ! npm view "${PACKAGE_NAME}@${NEW_VERSION}" version >/dev/null 2>&1; then
                              echo "   ðŸ—‘ï¸  Deleting tag $TAG (npm version doesn't exist)"
                              git tag -d "$TAG" 2>/dev/null || true
                              git push origin ":refs/tags/$TAG" 2>/dev/null || true
                              echo "   âœ… Tag deleted - will be recreated by nx release version"
                            fi
                          fi
                        fi
                      fi
                    fi
                  done
                  
                  echo "   âœ… Cleaned up tags where npm versions don't exist"
                  echo "   ðŸ”„ Retrying version command (will recreate deleted tags)..."
                  
                  # Retry the version command
                  if [ "${{ inputs.version-specifier }}" != "auto" ]; then
                    pnpm nx release version ${{ inputs.version-specifier }} --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
                  else
                    pnpm nx release version --projects=$AFFECTED_PROJECTS 2>&1 | tee /tmp/nx-release-output.log
                  fi
                  RETRY_EXIT_CODE=${PIPESTATUS[0]}
                  if [ "$RETRY_EXIT_CODE" -ne 0 ]; then
                    echo "   âŒ Retry failed with exit code: $RETRY_EXIT_CODE"
                    cat /tmp/nx-release-output.log
                    exit $RETRY_EXIT_CODE
                  fi
                  
                  # Verify tags were recreated for packages that need publishing
                  echo "   ðŸ” Verifying tags were recreated for unpublished packages..."
                  for FILE in $UPDATED_FILES; do
                    if [ -f "$FILE" ]; then
                      PACKAGE_NAME=$(node -p "require('./$FILE').name" 2>/dev/null || echo "")
                      NEW_VERSION=$(node -p "require('./$FILE').version" 2>/dev/null || echo "")
                      PROJECT=$(echo "$FILE" | sed -n 's|.*packages/\([^/]*\)/.*|\1|p')
                      
                      if [ -n "$PACKAGE_NAME" ] && [ -n "$NEW_VERSION" ] && [ -n "$PROJECT" ]; then
                        TAG="${PROJECT}@${NEW_VERSION}"
                        # Only verify if npm version doesn't exist (we want to publish this)
                        if ! npm view "${PACKAGE_NAME}@${NEW_VERSION}" version >/dev/null 2>&1; then
                          if git rev-parse "$TAG" >/dev/null 2>&1; then
                            echo "      âœ… Tag $TAG was successfully recreated"
                          else
                            echo "      âš ï¸  Warning: Tag $TAG was not recreated, creating manually..."
                            COMMIT_SHA=$(git rev-parse HEAD)
                            git tag "$TAG" "$COMMIT_SHA"
                            echo "      âœ… Manually created tag $TAG"
                          fi
                        fi
                      fi
                    fi
                  done
                else
                  echo "   âŒ Could not determine which tags to check"
                  exit $EXIT_CODE
                fi
              fi
            else
              echo "   âŒ Version command failed for a different reason"
              cat /tmp/nx-release-output.log
              exit $EXIT_CODE
            fi
          fi

          echo "status=success" >> $GITHUB_OUTPUT

          # Cleanup temporary log files
          rm -f /tmp/nx-release-output.log 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 2: CREATE RELEASE PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # After nx release version creates commits and tags, create a PR with all changes
      - name: ðŸ“ Create Release PR
        if: inputs.dry-run == false
        run: |
          echo "ðŸ“ Creating release PR with version changes..."

          # Fetch latest from origin
          git fetch origin main

          # Check for new commits and tags created by nx release version
          COMMITS=$(git log origin/main..HEAD --oneline | wc -l | tr -d ' ')
          TAGS=$(git tag --list --no-merged origin/main | wc -l | tr -d ' ')

          if [ "$COMMITS" -eq 0 ] && [ "$TAGS" -eq 0 ]; then
            echo "â„¹ï¸  No new changes - versions already on main, skipping PR creation"
          else
            echo "ðŸ“ Found $COMMITS commit(s) and $TAGS tag(s) to release"
            
            # Create release branch from current state (after nx release version)
            RELEASE_BRANCH="chore/release-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$RELEASE_BRANCH"
            
            # Push branch with commits and tags
            echo "ðŸ“¤ Pushing release branch with commits and tags..."
            git push origin "$RELEASE_BRANCH" || exit 1
            
            # Push tags (ignore errors if tags already exist - they may have been pushed in a previous attempt)
            echo "ðŸ“¤ Pushing tags..."
            if git push origin --tags 2>&1 | tee /tmp/tag-push.log; then
              echo "âœ… Tags pushed successfully"
            else
              TAG_PUSH_EXIT=${PIPESTATUS[0]}
              if grep -q "already exists\|Everything up-to-date" /tmp/tag-push.log; then
                echo "âš ï¸  Some tags already exist on remote (from previous attempt)"
                echo "   This is safe - tags are already pushed, continuing..."
              else
                echo "âŒ Tag push failed with unexpected error:"
                cat /tmp/tag-push.log
                exit $TAG_PUSH_EXIT
              fi
            fi
            
            # Create PR using GitHub CLI (always available in GitHub Actions)
            PR_TITLE="chore(release): Update package versions"
            PR_BODY=$(printf "ðŸ¤– **Automated Release PR**\n\nThis PR contains:\n- Package version updates\n- CHANGELOG updates\n- Git tags: %s\n\n**Note:** Packages are being published to npm in parallel with this PR." "$TAGS")
            
            # Try to create PR (capture both output and exit code)
            set +e  # Temporarily disable exit on error
            PR_OUTPUT=$(gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$RELEASE_BRANCH" \
              --json url --jq '.url' 2>&1)
            PR_EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            if [ $PR_EXIT_CODE -eq 0 ] && [ -n "$PR_OUTPUT" ]; then
              echo "âœ… Created release PR: $PR_OUTPUT"
              echo "pr_url=$PR_OUTPUT" >> $GITHUB_ENV
            else
              echo "âš ï¸  Failed to create PR via CLI (exit code: $PR_EXIT_CODE)"
              echo "   Branch is pushed and ready for manual PR creation:"
              echo "   https://github.com/${{ github.repository }}/compare/main...$RELEASE_BRANCH?expand=1"
              if [ -n "$PR_OUTPUT" ]; then
                echo "   Error output: $PR_OUTPUT"
              fi
              # Don't fail the workflow - publishing can still proceed
              echo "â„¹ï¸  Continuing workflow - publishing will proceed"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 3: PUBLISH PACKAGES
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Publish SCOPED packages that were affected by the latest commits (based on tags)
      - name: ðŸš€ Publish Scoped Packages
        id: publish
        if: inputs.dry-run == false
        run: |
          echo "ðŸš€ Publishing SCOPED packages with dist tag: ${{ inputs.dist-tag }}"
          echo ""
          echo "ðŸ“¦ This workflow publishes SCOPED packages only (@forge-js/*):"
          echo "   - @forge-js/eslint-plugin-llm-optimized"
          echo "   - @forge-js/eslint-plugin-utils"
          echo "   - @forge-js/cli"
          echo ""
          echo "ðŸ“¦ For UNscoped packages, use: release-unscoped.yml workflow"
          echo ""
          echo "ðŸ“¦ Nx will automatically publish only packages affected by recent commits"
          echo "   (determined by git tags created in the version step)"
          echo ""

          # Configure git user
          git config user.name "Ofri Peretz"
          git config user.email "ofriperetzdev@gmail.com"

          # Verify Trusted Publishing is available
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN not found - Trusted Publishing not configured"
            echo "   Check: https://www.npmjs.com/org/forge-js/settings/publishing"
            exit 1
          fi

          echo "âœ… Trusted Publishing verified (NODE_AUTH_TOKEN found)"
          echo "   Scope: @forge-js (configured in setup-node@v6)"
          echo "   Authentication: OIDC via Trusted Publishing"

          # Verify .npmrc configuration
          if [ -f ".npmrc" ]; then
            echo "âœ… .npmrc found"
            echo "   All packages in this workflow use Trusted Publishing (OIDC)"
            echo ""
            echo "   Packages being published:"
            echo "   - @forge-js/eslint-plugin-llm-optimized â†’ Trusted Publishing"
            echo "   - @forge-js/eslint-plugin-utils â†’ Trusted Publishing"
            echo "   - @forge-js/cli â†’ Trusted Publishing"
          fi

          # Publish packages
          # Nx automatically handles dependency order via "^nx-release-publish" in project.json
          # Publish order: eslint-plugin-utils â†’ eslint-plugin â†’ dependents
          echo ""
          echo "ðŸ“¤ Publishing packages with nx release publish..."
          echo "   Nx will publish in dependency order based on project.json 'dependsOn' configuration"
          echo ""

          # Explicit list of scoped packages
          SCOPED_PROJECTS="eslint-plugin,eslint-plugin-utils,cli"

          # Get affected projects and filter to only scoped packages
          echo "ðŸ” Detecting affected scoped packages for publishing..."
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --base=HEAD~1 2>/dev/null | grep -E "^($(echo $SCOPED_PROJECTS | tr ',' '|'))$" | tr '\n' ',' | sed 's/,$//' || echo "")

          if [ -z "$AFFECTED_PROJECTS" ]; then
            echo "â„¹ï¸  No affected scoped packages detected"
            echo "   Checking for packages with new tags (from version step)..."
            # Check for packages that have new tags (created in version step)
            for PROJECT in $(echo $SCOPED_PROJECTS | tr ',' ' '); do
              # Check if there's a new tag for this project
              LATEST_TAG=$(git tag --sort=-version:refname | grep "^${PROJECT}@" | head -n 1)
              if [ -n "$LATEST_TAG" ]; then
                # Check if tag is new (not in remote or different from previous)
                if [ -z "$AFFECTED_PROJECTS" ]; then
                  AFFECTED_PROJECTS="$PROJECT"
                else
                  AFFECTED_PROJECTS="$AFFECTED_PROJECTS,$PROJECT"
                fi
                echo "   - $PROJECT: has new tag $LATEST_TAG"
              fi
            done
          fi

          if [ -z "$AFFECTED_PROJECTS" ]; then
            echo "âœ… No scoped packages to publish - nothing was versioned"
            exit 0
          fi

          echo "ðŸ“¦ Publishing affected SCOPED packages: $AFFECTED_PROJECTS"
          echo "   (filtered from explicit list: $SCOPED_PROJECTS)"
          echo ""

          # Run publish command and capture output
          PUBLISH_OUTPUT=$(pnpm nx release publish --tag ${{ inputs.dist-tag }} --projects=$AFFECTED_PROJECTS 2>&1) || PUBLISH_EXIT=$?
          if [ -z "$PUBLISH_EXIT" ] || [ "$PUBLISH_EXIT" -eq 0 ]; then
            echo "âœ… All packages published successfully"
          else
            echo ""
            echo "âš ï¸  Publishing encountered issues (exit code: ${PUBLISH_EXIT:-1})"
            echo ""
            
            # Check for "already published" errors (403/409) - these are safe to ignore
            ALREADY_PUBLISHED_COUNT=$(echo "$PUBLISH_OUTPUT" | grep -c "already published\|cannot publish over\|E403\|E409" || true)
            ALREADY_PUBLISHED_COUNT=${ALREADY_PUBLISHED_COUNT:-0}
            UNEXPECTED_ERRORS=$(echo "$PUBLISH_OUTPUT" | grep -v "already published\|cannot publish over\|E403\|E409" | grep -i "error\|failed" || echo "")
            
            if [ "$ALREADY_PUBLISHED_COUNT" -gt 0 ]; then
              echo "â„¹ï¸  Found $ALREADY_PUBLISHED_COUNT package(s) already published on npm"
              echo "   This is safe - packages were published in a previous attempt"
              echo "   Continuing workflow..."
              echo ""
            fi
            
            # Check if there are unexpected errors (not "already published")
            if [ -n "$UNEXPECTED_ERRORS" ]; then
              echo "âŒ Unexpected publishing errors detected:"
              echo ""
              echo "$PUBLISH_OUTPUT" | grep -i "error\|failed" | grep -v "already published\|cannot publish over\|E403\|E409" || echo "$PUBLISH_OUTPUT"
              echo ""
              
              # Check specifically for 404 errors
              if echo "$PUBLISH_OUTPUT" | grep -q "E404\|404 Not Found"; then
                echo "ðŸ” 404 Error Analysis:"
                echo ""
                echo "404 errors mean the package doesn't exist in npm registry."
                echo ""
                echo "For Scoped Packages (@forge-js/*) with 404:"
                echo "  âŒ This indicates Trusted Publishing is NOT working"
                echo "  â†’ The package should be created automatically on first publish"
                echo "  â†’ 404 means npm can't find/create the package"
                echo "  â†’ Check: https://www.npmjs.com/org/forge-js/settings/publishing"
                echo "  â†’ Verify GitHub Actions is listed as a Trusted Publisher"
                echo "  â†’ Ensure the workflow has 'id-token: write' permission"
                echo ""
                echo "For Unscoped Packages (eslint-plugin-*) with 404:"
                echo "  â†’ Trusted Publishing doesn't work for unscoped packages by default"
                echo "  â†’ NPM_TOKEN (Granular Access Token) should be configured"
                echo "  â†’ Verify NPM_TOKEN secret is set in GitHub repository secrets"
                echo "  â†’ Check token has 'Publish packages' permission"
                echo "  â†’ Options:"
                echo "    1. Verify NPM_TOKEN secret is correctly set"
                echo "    2. Check token permissions include 'Publish packages'"
                echo "    3. Move packages to @forge-js scope (recommended long-term)"
                echo ""
              else
                echo "ðŸ” Troubleshooting by package type:"
                echo ""
                echo "For Scoped Packages (@forge-js/*):"
                echo "  â†’ Trusted Publishing should work automatically"
                echo "  â†’ Verify: https://www.npmjs.com/org/forge-js/settings/publishing"
                echo "  â†’ Packages: @forge-js/eslint-plugin-llm-optimized, @forge-js/eslint-plugin-utils, @forge-js/cli"
                echo ""
                echo "For Unscoped Packages (eslint-plugin-*):"
                echo "  â†’ Trusted Publishing doesn't work for unscoped packages"
                echo "  â†’ Using NPM_TOKEN (Granular Access Token) - verify it's configured"
                echo "  â†’ Packages: eslint-plugin-llm-optimized, eslint-plugin-llm, eslint-plugin-mcp, eslint-plugin-mcp-optimized"
                echo "  â†’ Check: NPM_TOKEN secret exists and has 'Publish packages' permission"
                echo ""
              fi
              
              exit ${PUBLISH_EXIT:-1}
            else
              # Only "already published" errors - safe to continue
              echo "âœ… All errors were 'already published' - workflow can continue"
              echo "   Remaining packages (if any) will be published on next run"
            fi
          fi

          # Cleanup temporary log files
          rm -f /tmp/publish-output.log 2>/dev/null || true
        env:
          NPM_CONFIG_PROVENANCE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NODE_AUTH_TOKEN is automatically set by setup-node@v6 for Trusted Publishing (scoped packages)
          # NPM_TOKEN is NOT needed - this workflow only handles scoped packages
          # Nx Cloud disabled - using local cache only
          NX_SKIP_NX_CLOUD: "true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DRY RUN: Just preview changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Dry Run Preview
        if: inputs.dry-run == true
        run: |
          echo "ðŸ” DRY RUN MODE: Previewing changes only"

          # Construct the dry-run flag
          DRY_RUN_FLAG="--dry-run"

          # Explicit list of scoped packages
          SCOPED_PROJECTS="eslint-plugin,eslint-plugin-utils,cli"

          # Get affected projects and filter to only scoped packages
          echo "ðŸ” Detecting affected scoped packages for dry-run..."
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --base=HEAD~1 2>/dev/null | grep -E "^($(echo $SCOPED_PROJECTS | tr ',' '|'))$" | tr '\n' ',' | sed 's/,$//' || echo "")

          if [ -z "$AFFECTED_PROJECTS" ]; then
            echo "â„¹ï¸  No affected scoped packages detected - will preview all scoped packages"
            AFFECTED_PROJECTS="$SCOPED_PROJECTS"
          fi

          echo "ðŸ“¦ DRY RUN: Previewing affected SCOPED packages: $AFFECTED_PROJECTS"
          echo "   (filtered from explicit list: $SCOPED_PROJECTS)"
          echo ""

          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Previewing version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }} --projects=$AFFECTED_PROJECTS $DRY_RUN_FLAG
          else
            echo "ðŸ“ Previewing conventional commits version"
            pnpm nx release version --projects=$AFFECTED_PROJECTS $DRY_RUN_FLAG
          fi
        env:
          # Nx Cloud disabled - using local cache only
          NX_SKIP_NX_CLOUD: "true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY REPORTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generate Release Summary
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "## ðŸ” Dry Run Preview Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** ${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… This was a dry-run preview - no changes committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** \`${{ inputs.dist-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-utils\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/cli\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To install the new version:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pnpm add @forge-js/eslint-plugin@${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
