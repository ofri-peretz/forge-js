# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  workflow_dispatch:
    inputs:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION STRATEGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      version-specifier:
        description: "Version bump strategy (auto = conventional commits)"
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
          - premajor
          - preminor
          - prepatch
          - prerelease
        default: "auto"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NPM PUBLISHING OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      dist-tag:
        description: "NPM distribution tag"
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
          - rc
          - alpha
          - canary
        default: "latest"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CONTROL FLOW OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      run-ci:
        description: "Run CI validation before publishing (slows down release)"
        required: false
        type: boolean
        default: true

      dry-run:
        description: "Dry run: preview changes without modifying git or NPM"
        required: false
        type: boolean
        default: false

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL ENVIRONMENT VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.18.3"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: CI VALIDATION (Optional, skippable)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-ci:
    name: âœ… CI Validation
    runs-on: ubuntu-latest
    if: inputs.run-ci == true
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: none

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true # Fetch tags for completeness (though not strictly needed for CI validation)

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      - name: ðŸ§ª Test all packages
        run: pnpm nx run-many -t test --all -c ci --parallel=4 --verbose

      - name: ðŸ—ï¸ Build all packages
        run: pnpm nx run-many -t build --all --parallel=4 --verbose

      - name: âœ… CI validation passed
        run: |
          echo "## âœ… CI Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests and builds completed successfully." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: RELEASE (Version bump, build, changelog, tags, publish)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸš€ Release & Publish
    runs-on: ubuntu-latest
    environment: production
    # Only require CI if it was enabled and run
    if: always() && (inputs.run-ci == false || needs.validate-ci.result == 'success' || needs.validate-ci.result == 'skipped')
    needs: [validate-ci]
    timeout-minutes: 15
    permissions:
      contents: write # Required to push commits/tags and create PRs
      id-token: write # â† Required for Trusted Publishing (OIDC)
      pull-requests: write # Required to create PR if direct push fails

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: main # Always checkout main branch for releases (ensures all tags are reachable)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/
          cache: "pnpm"

      - name: ðŸ“‚ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # QUICK PRE-FLIGHT CHECK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Quick Pre-Flight Check
        if: inputs.dry-run == false
        run: |
          # Verify NPM authentication (Trusted Publishing / OIDC)
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN not found - Trusted Publishing not configured"
            exit 1
          fi
          echo "âœ… NPM authentication ready"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 1: PREPARE VERSION (Build + determine versions + update changelogs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ Prepare Release Version
        id: prepare
        if: inputs.dry-run == false
        run: |
          # Configure git user for automated commits
          git config user.name "Ofri Peretz"
          git config user.email "ofriperetzdev@gmail.com"

          # Function to run version command
          run_version_command() {
            if [ "${{ inputs.version-specifier }}" != "auto" ]; then
              echo "ðŸ“ Using version strategy: ${{ inputs.version-specifier }}"
              pnpm nx release version ${{ inputs.version-specifier }}
            else
              echo "ðŸ“ Using conventional commits to determine version"
              pnpm nx release version
            fi
          }

          # Try to run version command
          if ! run_version_command 2>&1 | tee /tmp/nx-release-output.log; then
            EXIT_CODE=${PIPESTATUS[0]}
            echo ""
            echo "âš ï¸  Version command failed with exit code: $EXIT_CODE"
            
            # Check if the error is about existing tags
            if grep -q "tag.*already exists" /tmp/nx-release-output.log; then
              echo "ðŸ§¹ Detected existing tags from previous failed release attempt"
              echo "   Checking if corresponding npm versions exist..."
              
              # Extract tag names from error message
              CONFLICTING_TAGS=$(grep -oE '[a-z-]+@[0-9]+\.[0-9]+\.[0-9]+' /tmp/nx-release-output.log | sort -u || echo "")
              
              if [ -n "$CONFLICTING_TAGS" ]; then
                for TAG in $CONFLICTING_TAGS; do
                  # Extract project name and version from tag (format: project@version)
                  PROJECT=$(echo "$TAG" | cut -d'@' -f1)
                  VERSION=$(echo "$TAG" | cut -d'@' -f2)
                  
                  echo "   ðŸ” Checking tag: $TAG"
                  
                  # Get package name from project.json or package.json
                  PACKAGE_NAME=""
                  if [ -f "packages/${PROJECT}/package.json" ]; then
                    PACKAGE_NAME=$(node -p "require('./packages/${PROJECT}/package.json').name" 2>/dev/null || echo "")
                  fi
                  
                  if [ -z "$PACKAGE_NAME" ]; then
                    # Try to map project name to package name
                    case "$PROJECT" in
                      "eslint-plugin")
                        PACKAGE_NAME="@forge-js/eslint-plugin-llm-optimized"
                        ;;
                      "eslint-plugin-utils")
                        PACKAGE_NAME="@forge-js/eslint-plugin-utils"
                        ;;
                      "cli")
                        PACKAGE_NAME="@forge-js/cli"
                        ;;
                      *)
                        PACKAGE_NAME="$PROJECT"
                        ;;
                    esac
                  fi
                  
                  # Check if version exists on npm
                  echo "      Checking npm for: $PACKAGE_NAME@$VERSION"
                  if npm view "${PACKAGE_NAME}@${VERSION}" version >/dev/null 2>&1; then
                    echo "      âœ… Version $VERSION exists on npm - skipping tag deletion"
                    echo "      â„¹ï¸  Package already published, will skip in publish step"
                  else
                    echo "      âŒ Version $VERSION does NOT exist on npm"
                    echo "      ðŸ—‘ï¸  Deleting tag $TAG (tag exists but npm version doesn't)"
                    git tag -d "$TAG" 2>/dev/null || true
                    git push origin ":refs/tags/$TAG" 2>/dev/null || true
                    echo "      âœ… Tag deleted - will be recreated by nx release version"
                  fi
                done
                
                echo "   âœ… Cleaned up tags where npm versions don't exist"
                echo "   ðŸ”„ Retrying version command (will recreate deleted tags)..."
                run_version_command
                
                # Verify tags were recreated
                echo "   ðŸ” Verifying tags were recreated..."
                for TAG in $CONFLICTING_TAGS; do
                  PROJECT=$(echo "$TAG" | cut -d'@' -f1)
                  VERSION=$(echo "$TAG" | cut -d'@' -f2)
                  
                  if [ -f "packages/${PROJECT}/package.json" ]; then
                    PACKAGE_NAME=$(node -p "require('./packages/${PROJECT}/package.json').name" 2>/dev/null || echo "")
                    if [ -z "$PACKAGE_NAME" ]; then
                      case "$PROJECT" in
                        "eslint-plugin")
                          PACKAGE_NAME="@forge-js/eslint-plugin-llm-optimized"
                          ;;
                        "eslint-plugin-utils")
                          PACKAGE_NAME="@forge-js/eslint-plugin-utils"
                          ;;
                        "cli")
                          PACKAGE_NAME="@forge-js/cli"
                          ;;
                        *)
                          PACKAGE_NAME="$PROJECT"
                          ;;
                      esac
                    fi
                    
                    # Only check if npm version doesn't exist (we deleted the tag for these)
                    if ! npm view "${PACKAGE_NAME}@${VERSION}" version >/dev/null 2>&1; then
                      if git rev-parse "$TAG" >/dev/null 2>&1; then
                        echo "      âœ… Tag $TAG was successfully recreated"
                      else
                        echo "      âš ï¸  Warning: Tag $TAG was not recreated, creating manually..."
                        # Get the current commit (where package.json was updated)
                        COMMIT_SHA=$(git rev-parse HEAD)
                        git tag "$TAG" "$COMMIT_SHA"
                        echo "      âœ… Manually created tag $TAG"
                      fi
                    fi
                  fi
                done
              else
                # Fallback: try to extract from updated package.json files
                echo "   ðŸ” Attempting to extract from package.json files..."
                UPDATED_FILES=$(git diff --name-only HEAD packages/*/package.json dist/packages/*/package.json 2>/dev/null || echo "")
                
                if [ -n "$UPDATED_FILES" ]; then
                  for FILE in $UPDATED_FILES; do
                    if [ -f "$FILE" ]; then
                      PACKAGE_NAME=$(node -p "require('./$FILE').name" 2>/dev/null || echo "")
                      NEW_VERSION=$(node -p "require('./$FILE').version" 2>/dev/null || echo "")
                      
                      if [ -n "$PACKAGE_NAME" ] && [ -n "$NEW_VERSION" ]; then
                        # Map to project name
                        PROJECT=$(echo "$FILE" | sed -n 's|.*packages/\([^/]*\)/.*|\1|p')
                        if [ -n "$PROJECT" ]; then
                          TAG="${PROJECT}@${NEW_VERSION}"
                          if git rev-parse "$TAG" >/dev/null 2>&1; then
                            # Check npm
                            if ! npm view "${PACKAGE_NAME}@${NEW_VERSION}" version >/dev/null 2>&1; then
                              echo "   ðŸ—‘ï¸  Deleting tag $TAG (npm version doesn't exist)"
                              git tag -d "$TAG" 2>/dev/null || true
                              git push origin ":refs/tags/$TAG" 2>/dev/null || true
                              echo "   âœ… Tag deleted - will be recreated by nx release version"
                            fi
                          fi
                        fi
                      fi
                    fi
                  done
                  
                  echo "   âœ… Cleaned up tags where npm versions don't exist"
                  echo "   ðŸ”„ Retrying version command (will recreate deleted tags)..."
                  run_version_command
                  
                  # Verify tags were recreated for packages that need publishing
                  echo "   ðŸ” Verifying tags were recreated for unpublished packages..."
                  for FILE in $UPDATED_FILES; do
                    if [ -f "$FILE" ]; then
                      PACKAGE_NAME=$(node -p "require('./$FILE').name" 2>/dev/null || echo "")
                      NEW_VERSION=$(node -p "require('./$FILE').version" 2>/dev/null || echo "")
                      PROJECT=$(echo "$FILE" | sed -n 's|.*packages/\([^/]*\)/.*|\1|p')
                      
                      if [ -n "$PACKAGE_NAME" ] && [ -n "$NEW_VERSION" ] && [ -n "$PROJECT" ]; then
                        TAG="${PROJECT}@${NEW_VERSION}"
                        # Only verify if npm version doesn't exist (we want to publish this)
                        if ! npm view "${PACKAGE_NAME}@${NEW_VERSION}" version >/dev/null 2>&1; then
                          if git rev-parse "$TAG" >/dev/null 2>&1; then
                            echo "      âœ… Tag $TAG was successfully recreated"
                          else
                            echo "      âš ï¸  Warning: Tag $TAG was not recreated, creating manually..."
                            COMMIT_SHA=$(git rev-parse HEAD)
                            git tag "$TAG" "$COMMIT_SHA"
                            echo "      âœ… Manually created tag $TAG"
                          fi
                        fi
                      fi
                    fi
                  done
                else
                  echo "   âŒ Could not determine which tags to check"
                  exit $EXIT_CODE
                fi
              fi
            else
              echo "   âŒ Version command failed for a different reason"
              cat /tmp/nx-release-output.log
              exit $EXIT_CODE
            fi
          fi

          echo "status=success" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 2: CREATE RELEASE PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # After nx release version creates commits and tags, create a PR with all changes
      - name: ðŸ“ Create Release PR
        if: inputs.dry-run == false
        run: |
          echo "ðŸ“ Creating release PR with version changes..."

          # Fetch latest from origin
          git fetch origin main

          # Check for new commits and tags created by nx release version
          COMMITS=$(git log origin/main..HEAD --oneline | wc -l | tr -d ' ')
          TAGS=$(git tag --list --no-merged origin/main | wc -l | tr -d ' ')

          if [ "$COMMITS" -eq 0 ] && [ "$TAGS" -eq 0 ]; then
            echo "â„¹ï¸  No new changes - versions already on main, skipping PR creation"
          else
            echo "ðŸ“ Found $COMMITS commit(s) and $TAGS tag(s) to release"
            
            # Create release branch from current state (after nx release version)
            RELEASE_BRANCH="chore/release-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$RELEASE_BRANCH"
            
            # Push branch with commits and tags
            echo "ðŸ“¤ Pushing release branch with commits and tags..."
            git push origin "$RELEASE_BRANCH" || exit 1
            
            # Push tags (ignore errors if tags already exist - they may have been pushed in a previous attempt)
            echo "ðŸ“¤ Pushing tags..."
            if git push origin --tags 2>&1 | tee /tmp/tag-push.log; then
              echo "âœ… Tags pushed successfully"
            else
              TAG_PUSH_EXIT=${PIPESTATUS[0]}
              if grep -q "already exists\|Everything up-to-date" /tmp/tag-push.log; then
                echo "âš ï¸  Some tags already exist on remote (from previous attempt)"
                echo "   This is safe - tags are already pushed, continuing..."
              else
                echo "âŒ Tag push failed with unexpected error:"
                cat /tmp/tag-push.log
                exit $TAG_PUSH_EXIT
              fi
            fi
            
            # Create PR using GitHub CLI (always available in GitHub Actions)
            PR_TITLE="chore(release): Update package versions"
            PR_BODY=$(printf "ðŸ¤– **Automated Release PR**\n\nThis PR contains:\n- Package version updates\n- CHANGELOG updates\n- Git tags: %s\n\n**Note:** Packages are being published to npm in parallel with this PR." "$TAGS")
            
            # GitHub CLI is always available in GitHub Actions
            PR_URL=$(gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$RELEASE_BRANCH" \
              --label "release" \
              --json url --jq '.url' 2>&1)
            
            if [ $? -eq 0 ]; then
              echo "âœ… Created release PR: $PR_URL"
              echo "pr_url=$PR_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸  Failed to create PR via CLI, but branch is pushed:"
              echo "   https://github.com/${{ github.repository }}/compare/main...$RELEASE_BRANCH?expand=1"
              echo "   Error: $PR_URL"
              # Don't fail the workflow - publishing can still proceed
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE 3: PUBLISH PACKAGES
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Publish packages that were affected by the latest commits (based on tags)
      - name: ðŸš€ Publish Packages
        id: publish
        if: inputs.dry-run == false
        run: |
          echo "ðŸš€ Publishing packages with dist tag: ${{ inputs.dist-tag }}"
          echo ""
          echo "ðŸ“¦ Nx will automatically publish only packages affected by recent commits"
          echo "   (determined by git tags created in the version step)"
          echo ""

          # Configure git user
          git config user.name "Ofri Peretz"
          git config user.email "ofriperetzdev@gmail.com"

          # Verify npm authentication (Trusted Publishing via OIDC)
          echo "ðŸ” Verifying npm authentication..."
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN not found"
            echo "   Trusted Publishing should set this automatically"
            echo "   Check npm org settings: https://www.npmjs.com/org/forge-js/settings/publishing"
            exit 1
          fi
          echo "âœ… NODE_AUTH_TOKEN found (Trusted Publishing working)"

          # Verify .npmrc is being used (for scoped packages)
          if [ -f ".npmrc" ]; then
            echo "âœ… .npmrc found - will configure @forge-js scope registry"
            echo "   Scoped packages: @forge-js/eslint-plugin-llm-optimized, @forge-js/eslint-plugin-utils, @forge-js/cli"
            echo "   Unscoped packages: eslint-plugin-llm-optimized, eslint-plugin-llm, eslint-plugin-mcp, eslint-plugin-mcp-optimized"
          fi

          # Publish packages
          # Nx automatically handles dependency order via "^nx-release-publish" in project.json
          # Publish order: eslint-plugin-utils â†’ eslint-plugin â†’ dependents
          echo ""
          echo "ðŸ“¤ Publishing packages with nx release publish..."
          echo "   Nx will publish in dependency order based on project.json 'dependsOn' configuration"
          echo ""

          if pnpm nx release publish --tag ${{ inputs.dist-tag }}; then
            echo "âœ… All packages published successfully"
          else
            EXIT_CODE=$?
            echo ""
            echo "âŒ Publishing failed with exit code: $EXIT_CODE"
            echo ""
            echo "ðŸ” Troubleshooting by package type:"
            echo ""
            echo "For Scoped Packages (@forge-js/*):"
            echo "  â†’ Trusted Publishing should work automatically"
            echo "  â†’ Verify: https://www.npmjs.com/org/forge-js/settings/publishing"
            echo "  â†’ Packages: @forge-js/eslint-plugin-llm-optimized, @forge-js/eslint-plugin-utils, @forge-js/cli"
            echo ""
            echo "For Unscoped Packages (eslint-plugin-*):"
            echo "  â†’ Trusted Publishing requires npm support approval"
            echo "  â†’ Contact npm support OR use NPM_TOKEN fallback"
            echo "  â†’ Packages: eslint-plugin-llm-optimized, eslint-plugin-llm, eslint-plugin-mcp, eslint-plugin-mcp-optimized"
            echo ""
            echo "If you see 404 errors for unscoped packages:"
            echo "  â†’ This is expected - Trusted Publishing doesn't work for unscoped packages by default"
            echo "  â†’ Options:"
            echo "    1. Contact npm support: https://github.com/npm/feedback/discussions"
            echo "    2. Add NPM_TOKEN secret for unscoped packages (fallback)"
            echo "    3. Move packages to @forge-js scope (recommended)"
            echo ""
            exit $EXIT_CODE
          fi
        env:
          NPM_CONFIG_PROVENANCE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DRY RUN: Just preview changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Dry Run Preview
        if: inputs.dry-run == true
        run: |
          echo "ðŸ” DRY RUN MODE: Previewing changes only"

          # Construct the dry-run flag
          DRY_RUN_FLAG="--dry-run"

          # Preview version changes
          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Previewing version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }} $DRY_RUN_FLAG
          else
            echo "ðŸ“ Previewing conventional commits version"
            pnpm nx release version $DRY_RUN_FLAG
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY REPORTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generate Release Summary
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "## ðŸ” Dry Run Preview Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** ${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… This was a dry-run preview - no changes committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dist Tag:** \`${{ inputs.dist-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-utils\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/cli\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-llm\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`@forge-js/eslint-plugin-mcp-optimized\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To install the new version:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pnpm add @forge-js/eslint-plugin@${{ inputs.dist-tag }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
