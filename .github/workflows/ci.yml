name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  workflow_dispatch:

# Prevent concurrent runs on the same branch to save quota
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Determine the environment based on the trigger
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'pull_request' && 'development' || 'staging' }}

    # Prevent hanging builds
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 1: PNPM PACKAGE MANAGER SETUP (BEFORE Node setup)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 2: NODE RUNTIME & BUILT-IN CACHING (NOW pnpm is available)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies (with cache)
        run: pnpm install --frozen-lockfile

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 3: DERIVE AFFECTED PACKAGES (no artifact caching)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Derive affected packages using NX
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 4: LINT, BUILD, TEST (FRESH - no artifact caching)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      # Lint
      - name: Lint (incremental)
        run: |
          export ESLINT_CACHE=true
          pnpm nx run-many -t lint --all --parallel=4 --verbose

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 4.5: LINTING FEEDBACK (PR ONLY)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ“ Lint Review Comments (PR only)
        if: github.event_name == 'pull_request'
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: "warning"
          reporter: "github-pr-review"
        continue-on-error: true

      # Build
      - name: Build (incremental)
        run: |
          export TSNODE_SKIP_TRANSPILATION=true
          pnpm nx run-many -t build --all --parallel=4 --verbose

      # Test
      - name: Run tests with coverage
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ðŸ“Š Running tests on affected packages only..."
            pnpm nx affected -t test --parallel=4 --verbose --coverage 2>&1 | grep -v "ENOENT.*coverage/.tmp" || true
          else
            echo "ðŸ“Š Running tests on all packages (main branch)..."
            pnpm nx run-many -t test --all --parallel=4 --verbose --coverage 2>&1 | grep -v "ENOENT.*coverage/.tmp" || true
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LAYER 5: POST-TEST ACTIONS (COVERAGE & REPORTS)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Collect coverage files
        id: coverage
        run: |
          COVERAGE_FILES=$(find . -maxdepth 3 -name "coverage-final.json" -type f 2>/dev/null | grep -v node_modules | tr '\n' ',' | sed 's/,$//')
          echo "files=$COVERAGE_FILES" >> $GITHUB_OUTPUT
          echo "Found coverage files: $COVERAGE_FILES"

      - name: Collect JUnit test reports
        id: tests
        run: |
          JUNIT_FILES=$(find . -maxdepth 3 -name "test-report.junit.xml" -type f 2>/dev/null | grep -v node_modules | tr '\n' ',' | sed 's/,$//')
          echo "files=$JUNIT_FILES" >> $GITHUB_OUTPUT
          echo "Found JUnit test report files: $JUNIT_FILES"

      - name: Upload coverage to Codecov
        if: steps.coverage.outputs.files != ''
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ steps.coverage.outputs.files }}
          flags: ${{ github.event_name == 'pull_request' && 'pr' || 'main' }}
          name: codecov-${{ github.event_name == 'pull_request' && 'pr' || 'main' }}
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload test analytics to Codecov
        if: steps.tests.outputs.files != ''
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ steps.tests.outputs.files }}
          flags: ${{ github.event_name == 'pull_request' && 'test-pr' || 'test-main' }}
          name: junit-${{ github.event_name == 'pull_request' && 'pr' || 'main' }}
          fail_ci_if_error: false
        continue-on-error: true

      - name: Print CI diagnostics
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "CI Execution Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Environment: ${{ github.event_name == 'pull_request' && 'development' || 'staging' }}"
          echo ""
          echo "pnpm store status:"
          du -sh ~/.pnpm-store 2>/dev/null || echo "Not available"
          echo ""
          echo "Node version:"
          node --version
          echo ""
          echo "pnpm version:"
          pnpm --version
          echo ""
          pnpm nx report
