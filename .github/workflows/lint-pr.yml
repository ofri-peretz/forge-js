name: CI - Lint

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Prevent concurrent runs on the same branch to save quota
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # LINTING WORKFLOW (Separate from main CI for faster feedback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # This workflow runs ESLint via Nx and provides feedback via reviewdog.
  # Set this as a required check in GitHub branch protection rules.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  lint:
    name: ESLint Review
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PNPM & NODE SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies (with cache)
        run: pnpm install --frozen-lockfile

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NX CLOUD - Remote caching for faster builds
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ”— Configure Nx Cloud (Optional)
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.NX_CLOUD_ACCESS_TOKEN }}" ]; then
            echo "ğŸ”— Connecting to Nx Cloud..."
            if npx nx connect-to-nx-cloud --quiet --no-interactive; then
              echo "âœ… Nx Cloud connected successfully"
            else
              echo "âš ï¸  Nx Cloud connection failed, using local cache only"
              echo "NX_SKIP_NX_CLOUD=true" >> $GITHUB_ENV
            fi
          else
            echo "â„¹ï¸  NX_CLOUD_ACCESS_TOKEN not set, using local cache only"
            echo "NX_SKIP_NX_CLOUD=true" >> $GITHUB_ENV
          fi
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ESLINT CACHE - Persist lint results between runs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Restore ESLint cache
        uses: actions/cache@v4
        with:
          path: |
            **/.eslintcache
            .eslintcache
          key: eslint-cache-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            eslint-cache-${{ github.ref }}-
            eslint-cache-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DERIVE AFFECTED PACKAGES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Derive affected packages using NX
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LINTING (Fast thanks to caches)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Lint affected packages (single pass with cache)
        run: |
          export ESLINT_CACHE=true

          # Function to run lint with error handling for Nx Cloud failures
          run_lint() {
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo "ğŸ“ Linting affected packages only..."
              LINT_CMD="pnpm nx affected -t lint --parallel=4 --verbose"
            else
              echo "ğŸ“ Linting all packages..."
              LINT_CMD="pnpm nx run-many -t lint --all --parallel=4 --verbose"
            fi
            
            # First attempt with Nx Cloud (if enabled)
            set +e  # Don't exit on error - we'll handle it
            eval "$LINT_CMD" 2>&1 | tee /tmp/lint-output.log
            LINT_EXIT=${PIPESTATUS[0]}
            set -e  # Re-enable exit on error
            
            # If command failed, check if it's Nx Cloud related
            if [ "$LINT_EXIT" -ne 0 ]; then
              # Check for any Nx Cloud related errors (quota, connection, auth, etc.)
              if grep -qiE "(nx.?cloud|quota|rate limit|429|too many requests|exceeded|connection.*failed|authentication.*failed|unauthorized|NX_CLOUD.*quota|rate.*limit.*exceeded|429.*Too Many Requests)" /tmp/lint-output.log; then
                echo ""
                echo "âš ï¸  Nx Cloud error detected - disabling Nx Cloud and retrying..."
                echo "   Error details:"
                grep -iE "(nx.?cloud|quota|rate limit|429|too many requests|exceeded|connection|authentication|unauthorized|NX_CLOUD)" /tmp/lint-output.log | head -5 || true
                echo ""
                echo "NX_SKIP_NX_CLOUD=true" >> $GITHUB_ENV
                export NX_SKIP_NX_CLOUD=true
                
                # Retry without Nx Cloud - this should succeed
                echo "ğŸ“ Retrying lint without Nx Cloud (using local cache only)..."
                set +e  # Don't exit on error for retry
                eval "$LINT_CMD"
                RETRY_EXIT=$?  # Capture exit code (no pipe in retry)
                set -e
                
                if [ "$RETRY_EXIT" -ne 0 ]; then
                  echo "âŒ Lint failed even without Nx Cloud - this is a real error"
                  exit $RETRY_EXIT
                else
                  echo "âœ… Lint succeeded without Nx Cloud"
                fi
              else
                # Not an Nx Cloud error - this is a real linting error
                echo "âŒ Lint failed with non-Nx Cloud error - exiting"
                exit $LINT_EXIT
              fi
            else
              echo "âœ… Lint succeeded with Nx Cloud"
            fi
          }

          run_lint

          # Cleanup temporary log files
          rm -f /tmp/lint-output.log 2>/dev/null || true
        env:
          # Skip Nx Cloud if connection failed or token not set (falls back to local cache)
          NX_SKIP_NX_CLOUD: ${{ env.NX_SKIP_NX_CLOUD || 'false' }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DIAGNOSTICS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Print lint diagnostics
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Lint Workflow Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo ""
          echo "Node version:"
          node --version
          echo ""
          echo "pnpm version:"
          pnpm --version
          echo ""
          echo "Nx Cloud status:"
          if [ "${{ env.NX_SKIP_NX_CLOUD }}" == "true" ]; then
            echo "  âš ï¸  Nx Cloud disabled (using local cache only)"
          else
            echo "  âœ… Nx Cloud enabled (if token configured)"
          fi
          echo ""
          pnpm nx report
