name: Manual Publish

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANUAL PUBLISH WORKFLOW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This workflow allows manual publishing to NPM with full control over:
# 1. CI Validation (ensure tests pass first)
# 2. Version preparation (update versions in code)
# 3. Publishing (push to NPM registry)
#
# You can run each step independently via workflow_dispatch parameters:
# - skip-ci: Skip CI checks and go straight to version/publish
# - prepare-only: Prepare version but don't publish
# - publish-only: Skip to publishing (for re-runs after manual prepare)
# - dry-run: Preview all changes without modifying git/npm

on:
  workflow_dispatch:
    inputs:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CONTROL FLOW OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      run-ci:
        description: "Step 1: Run CI validation first (tests, linting, builds)"
        required: true
        type: boolean
        default: true

      prepare-version:
        description: "Step 2: Prepare release (update versions, changelogs, create PR)"
        required: true
        type: boolean
        default: true

      publish-packages:
        description: "Step 3: Publish packages to NPM"
        required: true
        type: boolean
        default: false

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION STRATEGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      version-specifier:
        description: "How to bump version (auto = use conventional commits)"
        required: true
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
          - premajor
          - preminor
          - prepatch
          - prerelease
        default: "auto"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NPM PUBLISHING OPTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      dist-tag:
        description: "NPM distribution tag"
        required: true
        type: choice
        options:
          - latest
          - next
          - beta
          - rc
          - alpha
          - canary
        default: "latest"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DRY RUN MODE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      dry-run:
        description: "Dry run: Preview changes without modifying git or NPM"
        required: true
        type: boolean
        default: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL ENVIRONMENT VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  # Node.js version to use across all jobs
  NODE_VERSION: "20"
  # pnpm version to use across all jobs
  PNPM_VERSION: "10.18.3"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: VALIDATION & CI CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-ci:
    name: âœ… CI Validation
    # Run on GitHub-hosted Ubuntu runner
    runs-on: ubuntu-latest
    # Only run this job if run-ci parameter is true (can skip if already tested)
    if: inputs.run-ci == true
    # Timeout in case job hangs
    timeout-minutes: 15
    # Permissions needed: read repository, no ID tokens needed for testing
    permissions:
      contents: read
      id-token: none

    steps:
      # SETUP PHASE
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history needed for conventional commits analysis
          fetch-depth: 0

      # Install package manager before Node.js (required order)
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # Setup Node.js with pnpm cache support
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache pnpm dependencies for faster installs
          cache: "pnpm"

      # Install all workspace dependencies with locked versions
      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # DIAGNOSTIC PHASE
      # Print system info and Nx configuration for debugging
      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      # TEST & BUILD PHASE
      # Run all tests with coverage and parallel execution
      - name: ðŸ§ª Test all packages
        run: pnpm nx run-many -t test --all -c ci --parallel=4 --verbose

      # Build all packages to ensure no compilation errors
      - name: ðŸ—ï¸ Build all packages
        run: pnpm nx run-many -t build --all --parallel=4 --verbose

      - name: âœ… CI validation passed
        run: |
          echo "## âœ… CI Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests and builds completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You may now proceed with version preparation and publishing." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: VERSION PREPARATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ðŸ“ Prepare Release
    runs-on: ubuntu-latest
    # Wait for validate-ci job (if enabled) to complete before starting
    needs: [validate-ci]
    # Run if: prepare-version is true AND (CI was skipped OR CI passed)
    if: inputs.prepare-version == true && (inputs.run-ci == false || needs.validate-ci.result == 'success')
    timeout-minutes: 10
    # Permissions: write to update versions, create PRs/tags, need tokens for git operations
    permissions:
      contents: write
      id-token: write
      pull-requests: write

    steps:
      # SETUP PHASE
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history for conventional commits and git operations
          fetch-depth: 0
          # Use GitHub token to allow push access for creating commits/tags
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install package manager before Node.js (required order)
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # Setup Node.js with pnpm cache support
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # Cache optimization: get pnpm store path
      - name: ðŸ“‚ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # Cache pnpm packages between runs
      - name: ðŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Install dependencies with locked versions
      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # Build packages to ensure no compilation errors before version bump
      - name: ðŸ—ï¸ Build packages
        run: pnpm nx run-many -t build --all

      # VERSION PREPARATION PHASE
      # Update version files and create changelog entries
      - name: ðŸ“ Prepare version
        id: prepare
        run: |
          # Construct the dry-run flag if needed (preview without changes)
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "ðŸ” DRY RUN MODE: Previewing changes only"
            DRY_RUN_FLAG="--dry-run"
          fi

          # Run version command with correct flags
          # Note: --skip-publish doesn't exist for nx release version command
          if [ "${{ inputs.version-specifier }}" != "auto" ]; then
            echo "ðŸ“ Using version strategy: ${{ inputs.version-specifier }}"
            pnpm nx release version ${{ inputs.version-specifier }} $DRY_RUN_FLAG
          else
            echo "ðŸ“ Using conventional commits to determine version"
            pnpm nx release version $DRY_RUN_FLAG
          fi

          echo "status=success" >> $GITHUB_OUTPUT
        env:
          # Token for git operations (commit, tag, push)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Generate summary
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            DRY_RUN_MSG="(DRY RUN - No changes committed)"
          else
            DRY_RUN_MSG=""
          fi

          echo "## ðŸ“ Release Prepared $DRY_RUN_MSG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created with version updates." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the PR with version and changelog changes" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-run this workflow with \`prepare-version: false\` and \`publish-packages: true\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: NPM PUBLISHING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: ðŸš€ Publish to NPM
    runs-on: ubuntu-latest
    # Wait for both validate-ci and prepare-release jobs (if enabled)
    needs: [validate-ci, prepare-release]
    # Run if: publish-packages is true AND all required job conditions met
    # Logic: skip dependencies if they were disabled, only fail if they failed
    if: |
      inputs.publish-packages == true && 
      (inputs.run-ci == false || needs.validate-ci.result == 'success') &&
      (inputs.prepare-version == false || needs.prepare-release.result == 'success')
    timeout-minutes: 10
    # Permissions: write to publish tags/releases, need tokens for NPM provenance
    permissions:
      contents: write
      id-token: write
      pull-requests: write

    steps:
      # SETUP PHASE
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history needed for release commit references
          fetch-depth: 0
          # GitHub token for git operations
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install package manager before Node.js (required order)
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # Setup Node.js with NPM registry URL for publishing
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Configure npm registry for publishing
          registry-url: https://registry.npmjs.org/
          cache: "pnpm"

      # Cache optimization: get pnpm store path
      - name: ðŸ“‚ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # Cache pnpm packages between runs
      - name: ðŸ”„ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Install dependencies with locked versions
      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # DIAGNOSTIC & BUILD PHASE
      # Print system info for debugging
      - name: ðŸ” Print Environment Info
        run: pnpm nx report

      # Build packages to ensure no compilation errors before publishing
      - name: ðŸ—ï¸ Build packages
        run: pnpm nx run-many -t build --all

      # PUBLISHING PHASE
      # Publish packages to NPM (or preview in dry-run mode)
      - name: ðŸš€ Publish packages
        id: publish
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            # Preview mode: show what would be published
            echo "ðŸ” DRY RUN MODE: Would publish with dist tag '${{ inputs.dist-tag }}'"
          else
            # Real publish: update config and publish
            echo "ðŸ“ Publishing with dist tag: ${{ inputs.dist-tag }}"
            
            # Update nx.json with the selected dist tag (allows tagging for beta/canary)
            jq '.release.publishTargets.npm.tag = "${{ inputs.dist-tag }}"' nx.json > nx.json.tmp
            mv nx.json.tmp nx.json
            
            # Actually publish packages to NPM
            pnpm nx release publish
          fi
        env:
          # NPM authentication token for publishing
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          # Enable NPM provenance (prove packages came from this workflow)
          NPM_CONFIG_PROVENANCE: true

      - name: ðŸ“ Create Release Summary
        if: inputs.dry-run == false
        run: |
          echo "## ðŸŽ‰ Packages Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dist Tag:** \`${{ inputs.dist-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/eslint-plugin\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/eslint-plugin-utils\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/cli\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ Create Dry-Run Summary
        if: inputs.dry-run == true
        run: |
          echo "## ðŸ” Dry-Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dist Tag:** \`${{ inputs.dist-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version Strategy:** ${{ inputs.version-specifier }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview" >> $GITHUB_STEP_SUMMARY
          echo "Would publish the following packages with tag \`${{ inputs.dist-tag }}\`:" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/eslint-plugin\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/eslint-plugin-utils\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`@forge-js/cli\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**No actual changes were made to git or NPM registry.**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comment on related PRs
        if: inputs.dry-run == false && success()
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ inputs.dist-tag }}';
            const message = `âœ… Packages published successfully with tag \`${tag}\`!\n\nYou can install them with:\n\`\`\`bash\npnpm add @forge-js/eslint-plugin@${tag}\n\`\`\``;

            // You could enhance this to find related PRs and comment on them
            console.log(message);
